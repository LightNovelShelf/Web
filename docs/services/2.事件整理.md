# 原始事件

> 本环节不注重通用语言等要求，旨在快速梳理出事件，方便下一步逐条澄清。

- 登陆 使用 不带token的 `widow.fetch` 请求
- 重置密码 使用 带token的 `widow.fetch` 请求
- 订阅通知 使用 `signalr.on(evt)` 接收通知
- 大部分业务请求 使用 `signalr.invoke(method, args)` 发出并等待响应，实现类似 req-res 形式的通信
- 连接状态组件 期望 能感知 `signalr` 的连接状态，方便直观给用户展示通信状态
- 服务器选择会切换 请求 的目标域名，包括 `window.fetch` 和 `signalr` 的连接
- 登录/退出登录 需要通知 `signalr` 切换身份，目前方法是 处理token记录后重启 `signalr` 连接

# 业务事件

> 根据原始事件，使用通用语言、标准格式描述事件，为下一步建模提供依据。

本节采用 DDD 术语对事件进行分类与分组：

- 领域事件（Domain Event）：反映领域内“已经发生的业务事实”。
- 应用事件（Application Event）：应用服务层流程进度/编排用事件。
- 集成事件（Integration Event）：跨边界上下文/跨进程（例如服务端→客户端）传播的事件。
- 技术事件（Technical Event）：实现细节层面的技术状态变更（传输/基础设施）。

并按边界上下文（Bounded Context）组织：身份与访问（Identity & Access）、通知（Notification）、实时通信（Realtime/Transport）、服务器路由（Server Routing）。

说明：每个事件均给出 名称(中/英)、类型、边界上下文、触发、聚合/实体、载荷、约束/幂等、主要订阅方。

## 身份与访问（Identity & Access）

1. 用户已登录（UserLoggedIn）

- 类型：领域事件
- 上下文：Identity
- 触发：登录命令执行成功（当前用 window.fetch 无 Token 调用登录接口）
- 聚合/实体：User（或 Session）
- 载荷：{ userId, sessionId, tokenId, token, expiresAt, issuedAt }
- 约束/幂等：相同 sessionId 重放应幂等；token 有有效期
- 主要订阅方：Realtime（绑定身份到连接）、Server Routing（如需按用户路由）、Notification（建立订阅）

2. 用户已登出（UserLoggedOut）

- 类型：领域事件
- 上下文：Identity
- 触发：登出命令成功（清除本地会话）
- 聚合/实体：User（或 Session）
- 载荷：{ userId, sessionId, reason }
- 约束/幂等：重复登出操作不应报错
- 主要订阅方：Realtime（解除/重建连接）、Notification（取消订阅）

3. 用户密码已重置（UserPasswordReset）

- 类型：领域事件
- 上下文：Identity
- 触发：重置密码命令成功（当前用 window.fetch，需携带 Token）
- 聚合/实体：User
- 载荷：{ userId, resetAt }
- 约束/幂等：事件不可撤销；可由审计追踪
- 主要订阅方：Identity（使旧 Token 失效）、Realtime（必要时强制重连）

4. 身份令牌已更新（AuthTokenRefreshed）

- 类型：应用事件
- 上下文：Identity
- 触发：登录成功、刷新 Token、或修改密码导致 Token 轮换
- 聚合/实体：Session
- 载荷：{ userId, oldTokenId?, tokenId, token, expiresAt }
- 约束/幂等：以 tokenId 为幂等键
- 主要订阅方：Realtime（更新连接身份）、HTTP 客户端（更新请求头）

## 通知（Notification）

5. 通知订阅已建立（NotificationSubscriptionEstablished）

- 类型：应用事件
- 上下文：Notification
- 触发：客户端为信道注册 signalr.on 监听器（订阅启动）
- 聚合/实体：Subscription
- 载荷：{ userId?, channels: string[], connectionId }
- 约束/幂等：同一 connectionId+channel 多次订阅应幂等
- 主要订阅方：Realtime（确保连接就绪）、UI（展示订阅状态）

6. 通知已接收（NotificationReceived）

- 类型：集成事件（服务端 → 客户端）
- 上下文：Notification
- 触发：服务端通过 SignalR 推送消息，客户端经 signalr.on 收到
- 聚合/实体：Notification
- 载荷：{ notificationId, type, payload, sentAt, receivedAt, correlationId? }
- 约束/幂等：notificationId 用于去重
- 主要订阅方：UI（提示/角标/消息列表）、本地存储（离线缓存）

## 实时通信（Realtime / Transport）

7. 实时连接状态已变更（RealtimeConnectionStateChanged）

- 类型：技术事件
- 上下文：Realtime
- 触发：SignalR 连接建立/断开/重试/失败等
- 聚合/实体：Connection
- 载荷：{ connectionId, prevState, currState, reason?, serverUrl, at }
- 约束/幂等：状态流按时间线追加；忽略无效回退
- 主要订阅方：UI（连接状态组件）、应用编排（断线重试/降级）

8. 身份已绑定到实时连接（IdentityAttachedToRealtimeConnection）

- 类型：应用事件
- 上下文：Realtime
- 触发：登录/刷新 Token 后，对 SignalR 连接完成身份绑定（当前实现为重启连接）
- 聚合/实体：Connection
- 载荷：{ userId, connectionId, tokenId, at }
- 约束/幂等：同一 connectionId+tokenId 重复绑定应幂等
- 主要订阅方：Notification（确保订阅以新身份生效）、应用指令调用

9. 实时连接已重建（RealtimeConnectionRebuilt）

- 类型：应用事件
- 上下文：Realtime
- 触发：因身份变更或路由切换导致的连接重启完成
- 聚合/实体：Connection
- 载荷：{ oldConnectionId?, connectionId, serverUrl, attempt, at }
- 约束/幂等：以 connectionId 为标识；与状态变更事件互补
- 主要订阅方：Notification、UI（恢复提示）

10. 业务请求已发送（BusinessRequestDispatched）

- 类型：技术事件
- 上下文：Realtime
- 触发：signalr.invoke(method, args) 发起请求
- 聚合/实体：Request
- 载荷：{ correlationId, method, args, timeoutMs?, at }
- 约束/幂等：correlationId 保证响应配对；客户端可重试
- 主要订阅方：应用编排（超时/重试/熔断）、日志

11. 业务响应已接收（BusinessResponseReceived）

- 类型：集成事件（服务端 → 客户端）
- 上下文：Realtime
- 触发：signalr.invoke 的响应返回
- 聚合/实体：Request
- 载荷：{ correlationId, success, result?, error?, receivedAt }
- 约束/幂等：以 correlationId 去重；一次请求仅一个最终响应
- 主要订阅方：应用编排（完成对应用例）、UI（结果呈现）

## 服务器路由（Server Routing / Endpoint Selection）

12. 服务器选择已变更（ServerSelectionChanged）

- 类型：应用事件
- 上下文：Server Routing
- 触发：用户/系统切换目标域名/环境（影响 fetch 与 SignalR）
- 聚合/实体：RouteConfig
- 载荷：{ previous: { baseUrl, signalrUrl }, current: { baseUrl, signalrUrl }, reason, at }
- 约束/幂等：相同目标的重复切换应忽略
- 主要订阅方：HTTP 客户端（更新 baseURL）、Realtime（重建连接）、UI（提示）

13. 服务端路由已切换完成（ServerRoutingSwitched）

- 类型：应用事件
- 上下文：Server Routing
- 触发：HTTP 基址与 SignalR 端点均更新成功，必要的重连完成
- 聚合/实体：RouteConfig
- 载荷：{ baseUrl, signalrUrl, connectionRebuilt: boolean, at }
- 约束/幂等：到达相同配置的完成事件合并
- 主要订阅方：应用编排（继续后续流程）、UI（状态稳定）

## 跨上下文编排（Process / Saga）

14. 用户会话环境已就绪（UserSessionEnvironmentReady）

- 类型：应用事件（编排产出）
- 上下文：Cross-Context
- 触发：以下条件全部满足：UserLoggedIn 或 AuthTokenRefreshed → RealtimeConnectionRebuilt → IdentityAttachedToRealtimeConnection → NotificationSubscriptionEstablished
- 聚合/实体：Session
- 载荷：{ userId, sessionId, connectionId, tokenId, at }
- 约束/幂等：相同 sessionId+connectionId 重复就绪不重复触发
- 主要订阅方：UI（解除骨架屏/加载态）、业务用例（开始实时交互）

---

建模备注：

- “window.fetch 是否带 Token”“signalr.invoke/on 的使用方式”属于技术/传输策略，不直接作为领域事实；已通过技术/应用事件显式表达其约束与副作用。
- 每个跨进程事件建议携带 { eventId, occurredAt, correlationId, causationId, version } 以支持追踪、演进与幂等。
- 连接状态组件可直接订阅 RealtimeConnectionStateChanged、ServerRoutingSwitched、RealtimeConnectionRebuilt 三类事件以渲染 UI。
